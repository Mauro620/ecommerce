{% extends 'base.html' %} 
{% load static %} 
{% block content %}
{% load humanize %}

<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <h1 class="title" id="products-section">Productos destacados</h1>
      {% for product in products %}
      <a href="{% url 'product_detail' product.product_id %}" class="text-decoration-none">
        <div class="card bg-light" style="border-radius: 15px; margin-top: 20px">
          <div class="row">
            <div class="col-md-4">
              <!-- Galería de imágenes con hover -->
              <div class="product-image-container">
                {% with first_image=product.images.first %}
                <!-- Imagen principal (siempre visible) -->
                <img 
                  src="{{ first_image.get_image_url }}" 
                  alt="{{ first_image.alt_text|default:product.name }}"
                  class="img-fluid main-product-image"
                  style="
                    border-radius: 15px;
                    height: 17rem;
                    width: 100%;
                    object-fit: cover;
                  ">
                
                <!-- Miniaturas para hover (ocultas inicialmente) -->
                <div class="hover-images">
                  {% for image in product.images.all %}
                    {% if not forloop.first %}
                    <img 
                      src="{{ image.get_image_url }}" 
                      alt="{{ image.alt_text|default:product.name }}"
                      class="img-fluid hover-image"
                      style="
                        border-radius: 15px;
                        height: 17rem;
                        width: 100%;
                        object-fit: cover;
                      "
                      onmouseover="changeImage(this, '{{ product.product_id }}')"
                      onmouseout="resetImage('{{ product.product_id }}')">
                    {% endif %}
                  {% endfor %}
                </div>
                {% endwith %}
              </div>
            </div>
            
            <div class="col-md-8">
              <div class="card-body">
                <h2 class="card-title">{{ product.name }}</h2>
                <div class="product-rating mb-2">
                  <p>
                    <span class="text-warning">
                      {% for i in rating_range %}
                        {% if i <= product.avg_rating %} 
                         <i class="bi bi-star-fill text-warning"></i> 
                        {% else %}
                        <i class="bi bi-star text-warning"></i>
                        {% endif %}   
                      {% endfor %}
                    </span>
                    <small class="text-muted">{{ product.avg_rating }}</small>
                  </p>
                </div>
                <p class="card-text">{{ product.description }}</p>
                <div class="mb-4">
                  <span class="h3 text-danger">${{ product.converted_price|intcomma }} {{ product.currency }}</span>
                  {% if product.offer_price %}
                  <span class="text-muted text-decoration-line-through ms-2">${{ product.converted_offer_price|intcomma }} {{product.currency}}</span>
                  <span class="badge bg-danger ms-2">Oferta</span>
                  {% endif %}
                </div>
                <button class="btn btn-success">Realizar mi pedido</button>
              </div>
            </div>
          </div>
        </div>
      </a>
      {% endfor %} 
    </div>
  </div>
</div>

<style>
  /* Estilos para la galería de imágenes */
  .product-image-container {
    position: relative;
    width: 100%;
  }
  
  .main-product-image {
    display: block;
    transition: opacity 0.3s ease;
  }
  
  .hover-images {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
  
  .hover-image {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .hover-image:hover {
    opacity: 1;
  }
</style>

<script>
  // Función para cambiar la imagen al pasar el cursor
  function changeImage(element, productId) {
    const container = element.closest('.product-image-container');
    const mainImage = container.querySelector('.main-product-image');
    mainImage.style.opacity = 0;
    
    setTimeout(() => {
      mainImage.src = element.src;
      mainImage.alt = element.alt;
      mainImage.style.opacity = 1;
    }, 150);
  }
  
  // Función para resetear la imagen al quitar el cursor
  function resetImage(productId) {
    const container = document.querySelector(`[data-product-id="${productId}"]`);
    if (container) {
      const mainImage = container.querySelector('.main-product-image');
      const firstImage = container.querySelector('.hover-image');
      if (firstImage) {
        mainImage.src = firstImage.src;
        mainImage.alt = firstImage.alt;
      }
    }
  }
</script>
{% endblock %}